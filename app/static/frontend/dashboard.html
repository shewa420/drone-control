<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –¥—Ä–æ–Ω–æ–º</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #fff;
      color: #111;
    }

    header {
      background-color: #d40000;
      color: white;
      padding: 15px 20px;
      font-size: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav a {
      color: white;
      text-decoration: none;
      margin-left: 20px;
    }

    .container {
      padding: 20px;
    }

    .gamepad-status {
      margin-top: 20px;
      font-size: 18px;
    }

    .stick-values {
      font-size: 16px;
      margin-top: 10px;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 6px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <header>
    <div>üõ∏ Drone Control</div>
    <nav>
      <a href="index.html">–í—Ö—ñ–¥</a>
      <a href="dashboard.html">–ü–∞–Ω–µ–ª—å</a>
      <a href="admin.html">–ê–¥–º—ñ–Ω</a>
    </nav>
  </header>

  <div class="container">
    <h1>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –¥—Ä–æ–Ω–æ–º</h1>
    <p id="status">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –¥–∂–æ–π—Å—Ç–∏–∫–∞ –∞–±–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏...</p>
    <div class="stick-values" id="sticks">X: 0.00 | Y: 0.00</div>
  </div>

  <script>
    let sent = {};

    async function sendCommand(command) {
      if (sent[command]) return;
      sent[command] = true;

      try {
        const res = await fetch('/api/drone/command', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command })
        });
        const data = await res.json();
        console.log(`‚úÖ ${command}:`, data.message || data.detail || "OK");
      } catch (err) {
        console.error(`‚ùå ${command}:`, err);
      }

      setTimeout(() => { sent[command] = false }, 300);
    }

    // üéÆ Gamepad
    window.addEventListener("gamepadconnected", () => {
      document.getElementById("status").textContent = "üéÆ –î–∂–æ–π—Å—Ç–∏–∫ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ!";
      pollGamepad();
    });

    function pollGamepad() {
      const gp = navigator.getGamepads()[0];
      if (!gp) return requestAnimationFrame(pollGamepad);

      const [lx, ly] = [gp.axes[0], gp.axes[1]];
      const btns = gp.buttons;

      document.getElementById("sticks").textContent = `X: ${lx.toFixed(2)} | Y: ${ly.toFixed(2)}`;

      btns.forEach((btn, i) => {
        if (btn.pressed) {
          console.log(`üéÆ Button ${i} pressed`);
        }
      });

      if (btns[0]?.pressed) sendCommand("ARM");
      if (btns[1]?.pressed) sendCommand("DISARM");
      if (btns[2]?.pressed) sendCommand("TAKEOFF");
      if (btns[3]?.pressed) sendCommand("LAND");

      if (ly < -0.5) sendCommand("FORWARD");
      if (ly >  0.5) sendCommand("BACKWARD");
      if (lx < -0.5) sendCommand("LEFT");
      if (lx >  0.5) sendCommand("RIGHT");

      requestAnimationFrame(pollGamepad);
    }

    // ‚å®Ô∏è –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞
    document.addEventListener("keydown", (e) => {
      console.log(`‚å®Ô∏è Key pressed: ${e.key}`);
      switch (e.key.toLowerCase()) {
        case "w": sendCommand("FORWARD"); break;
        case "s": sendCommand("BACKWARD"); break;
        case "a": sendCommand("LEFT"); break;
        case "d": sendCommand("RIGHT"); break;
        case " ": sendCommand("TAKEOFF"); break;
        case "l": sendCommand("LAND"); break;
        case "e": sendCommand("ARM"); break;
        case "q": sendCommand("DISARM"); break;
      }
    });
  </script>
</body>
</html>
