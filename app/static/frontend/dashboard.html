<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –¥—Ä–æ–Ω–æ–º: TX12 + –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞</title>
</head>
<body>
  <h1>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –¥—Ä–æ–Ω–æ–º</h1>
  <p id="status">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –¥–∂–æ–π—Å—Ç–∏–∫–∞ –∞–±–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏...</p>

  <script>
    let sent = {};

    async function sendCommand(command) {
      if (sent[command]) return;
      sent[command] = true;

      try {
        const res = await fetch('/api/drone/command', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command })
        });
        const data = await res.json();
        console.log(`‚úÖ ${command}:`, data.message || data.detail || "OK");
      } catch (err) {
        console.error(`‚ùå ${command}:`, err);
      }

      setTimeout(() => { sent[command] = false }, 300);
    }

    // üéÆ Gamepad
    window.addEventListener("gamepadconnected", () => {
      document.getElementById("status").textContent = "üéÆ –î–∂–æ–π—Å—Ç–∏–∫ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ!";
      console.log("üéÆ Gamepad connected:", navigator.getGamepads()[0]);
      pollGamepad();
    });

    function pollGamepad() {
      const gp = navigator.getGamepads()[0];
      if (!gp) return requestAnimationFrame(pollGamepad);

      const [lx, ly] = [gp.axes[0], gp.axes[1]];
      const btns = gp.buttons;

      btns.forEach((btn, i) => {
        if (btn.pressed) {
          console.log(`üéÆ Button ${i} pressed`);
        }
      });

      if (btns[0]?.pressed) sendCommand("ARM");
      if (btns[1]?.pressed) sendCommand("DISARM");
      if (btns[2]?.pressed) sendCommand("TAKEOFF");
      if (btns[3]?.pressed) sendCommand("LAND");

      if (ly < -0.5) sendCommand("FORWARD");
      if (ly >  0.5) sendCommand("BACKWARD");
      if (lx < -0.5) sendCommand("LEFT");
      if (lx >  0.5) sendCommand("RIGHT");

      requestAnimationFrame(pollGamepad);
    }

    // ‚å®Ô∏è Keyboard fallback
    document.addEventListener("keydown", (e) => {
      console.log(`‚å®Ô∏è Key pressed: ${e.key}`);
      switch (e.key.toLowerCase()) {
        case "w": sendCommand("FORWARD"); break;
        case "s": sendCommand("BACKWARD"); break;
        case "a": sendCommand("LEFT"); break;
        case "d": sendCommand("RIGHT"); break;
        case " ": sendCommand("TAKEOFF"); break;
        case "l": sendCommand("LAND"); break;
        case "e": sendCommand("ARM"); break;
        case "q": sendCommand("DISARM"); break;
      }
    });
  </script>
</body>
</html>
