<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –¥—Ä–æ–Ω–æ–º</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .channel-table {
            margin-top: 30px;
            font-size: 16px;
            text-align: center;
        }
        .channel-table th, .channel-table td {
            padding: 6px 14px;
        }
    </style>
</head>
<body>
<header>
    <div>üõ∏ Drone Control</div>
    <nav>
        <a href="index.html">–í—Ö—ñ–¥</a>
        <a href="dashboard.html">–ü–∞–Ω–µ–ª—å</a>
        <a href="admin.html">–ê–¥–º—ñ–Ω</a>
    </nav>
</header>
<div class="container">
    <h1>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –¥—Ä–æ–Ω–æ–º</h1>
    <p id="status">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –¥–∂–æ–π—Å—Ç–∏–∫–∞ –∞–±–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏...</p>
    <div class="stick-visual">
        <div>
            <div class="stick" id="stick-left">
                <div class="dot" id="dot-left"></div>
            </div>
            <div class="label">CH3 (THR) + CH4 (RUD)</div>
        </div>
        <div>
            <div class="stick" id="stick-right">
                <div class="dot" id="dot-right"></div>
            </div>
            <div class="label">CH1 (AIL) + CH2 (ELE)</div>
        </div>
    </div>
    <table class="channel-table">
        <tr>
            <th>CH5</th>
            <th>CH6</th>
            <th>CH7</th>
            <th>CH8</th>
        </tr>
        <tr>
            <td id="ch5-val">0%</td>
            <td id="ch6-val">0%</td>
            <td id="ch7-val">0%</td>
            <td id="ch8-val">0%</td>
        </tr>
    </table>
</div>
<script>
let sent = {};
async function sendCommand(command) {
    if (sent[command]) return;
    sent[command] = true;
    try {
        const res = await fetch('/api/drone/command', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command })
        });
        const data = await res.json();
        console.log(`‚úÖ ${command}:`, data.message || data.detail || "OK");
    } catch (err) {
        console.error(`‚ùå ${command}:`, err);
    }
    setTimeout(() => { sent[command] = false }, 300);
}

window.addEventListener("gamepadconnected", () => {
    document.getElementById("status").textContent = "üéÆ –î–∂–æ–π—Å—Ç–∏–∫ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ!";
    console.log("üéÆ Gamepad connected:", navigator.getGamepads()[0]);
    pollGamepad();
});

function pollGamepad() {
    const gp = navigator.getGamepads()[0];
    if (!gp) return requestAnimationFrame(pollGamepad);

    const [ali, ele, rud, thr] = [
        gp.axes[0] || 0,               // CH1 - AIL
        -gp.axes[1] || 0,              // CH2 - ELE (invert)
        gp.axes[2] || 0,               // CH4 - RUD
        -gp.axes[3] || 0               // CH3 - THR (invert)
    ];

    const dotL = document.getElementById("dot-left");
    const dotR = document.getElementById("dot-right");

    dotL.style.left = `${40 + rud * 30}px`;
    dotL.style.top = `${40 + thr * 30}px`;
    dotR.style.left = `${40 + ali * 30}px`;
    dotR.style.top = `${40 + ele * 30}px`;

    // –í—ã–≤–æ–¥ CH5 - CH8
    for (let i = 4; i <= 7; i++) {
        const percent = gp.axes[i] !== undefined ? ((gp.axes[i] + 1) / 2 * 100).toFixed(0) + "%" : "‚Äî";
        document.getElementById(`ch${i + 1}-val`).innerText = percent;
    }

    const btns = gp.buttons;
    if (btns[0]?.pressed) sendCommand("ARM");
    if (btns[1]?.pressed) sendCommand("DISARM");
    if (btns[2]?.pressed) sendCommand("TAKEOFF");
    if (btns[3]?.pressed) sendCommand("LAND");

    if (ele > 0.5) sendCommand("FORWARD");
    if (ele < -0.5) sendCommand("BACKWARD");
    if (ali < -0.5) sendCommand("LEFT");
    if (ali > 0.5) sendCommand("RIGHT");

    requestAnimationFrame(pollGamepad);
}

document.addEventListener("keydown", (e) => {
    console.log(`‚å®Ô∏è Key pressed: ${e.key}`);
    switch (e.key.toLowerCase()) {
        case "w": sendCommand("FORWARD"); break;
        case "s": sendCommand("BACKWARD"); break;
        case "a": sendCommand("LEFT"); break;
        case "d": sendCommand("RIGHT"); break;
        case " ": sendCommand("TAKEOFF"); break;
        case "l": sendCommand("LAND"); break;
        case "e": sendCommand("ARM"); break;
        case "q": sendCommand("DISARM"); break;
    }
});
</script>
</body>
</html>
